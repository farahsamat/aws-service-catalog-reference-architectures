{
    "Description": "Container Fargate Task Definition (fdp-1qj64b32n)",
    "AWSTemplateFormatVersion": "2010-09-09",
    "Parameters": {
        "ECRImageURI": {
            "Type": "String",
            "Description" : "Arc Public Docker Image URI - triplai/arc",
            "Default": "triplai/arc"
        },
        "ContainerDefinitionName": {
            "Type": "String",
            "Description" : "This will set the Task and Container Definition name in Fargate.",
            "Default": "arcetl"
        },       
        "ContainerPort": {
            "Type":"Number",
            "Description" : "port number exposed from the container image.",
            "Default":4040
        },
        "ContainerSize": {
            "Type":"String",
            "Description" : "Size of container for Fargate task.",
            "Default":"Small",
            "AllowedValues": ["Small","Medium","Large"]
        },
        "DataLakeS3Bucket":{
            "Type":"String",
            "Description" : "Name of S3 Bucket to trigger an ETL job",
            "Default":"arcdemo2020",
        }
    },
   "Mappings" : {
        "MapContainerSize" : {
            "Small" : {
                "cpu" : "2048" ,
                "mem" : "8192"
            },
            "Medium" : {
                "cpu" : "2048",
                "mem" : "16384"
            },
            "Large" : {
                "cpu" : "4096",
                "mem" : "30720"
            }
        }
    },
    "Resources": {
        "TaskLogGroup": {
          "Type" : "AWS::Logs::LogGroup",
          "Properties" : {
              "LogGroupName" : {"Fn::Sub":"/ecs/${ContainerDefinitionName}"},
              "RetentionInDays" : 30
            }
        },
        "LambdaExecutionRole": {
         "Type": "AWS::IAM::Role",
         "Properties": {
            "AssumeRolePolicyDocument": {
               "Version": "2012-10-17",
               "Statement": [
                  {
                     "Effect": "Allow",
                     "Principal": {
                        "Service": [ "lambda.amazonaws.com" ]
                     },
                     "Action": [ "sts:AssumeRole" ]
                  }
               ]
            },
            "Path": "/",
            "ManagedPolicyArns":["arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"],
            "Policies": [
               {
                  "PolicyName": { "Fn::Join": [ "-", [ { "Ref": "AWS::StackName" }, "lambda_run_ecs" ] ] },
                  "PolicyDocument": {
                     "Version": "2012-10-17",
                     "Statement": [
                        {
                           "Effect": "Allow",
                           "Action": [
                              "ecs:RunTask"
                           ],
                           "Resource": {
                              "Fn::Join": ["",["arn:aws:ecs:",{ "Ref": "AWS::Region" },":",{ "Ref": "AWS::AccountId" },":task-definition/",{"Ref": "ContainerDefinitionName"},":*"]]
                           },
                           "Condition": {"ArnLike":{"ecs:cluster": {"Fn::Join": ["",["arn:aws:ecs:",{ "Ref": "AWS::Region" },":",{ "Ref": "AWS::AccountId" },":cluster/",{"Ref": "ContainerDefinitionName"}]]}}}
                         },
                        {
                          "Action": "iam:PassRole",
                          "Effect": "Allow",
                          "Resource": {
                              "Fn::Join": ["",["arn:aws:iam::",{"Ref":"AWS::AccountId"},":role/*"]]
                          },
                          "Condition": {"StringLike": {"iam:PassedToService": "ecs-tasks.amazonaws.com"}}
                        }
                     ]
                  }
               }
            ]
         }
      }, 
        "LambdaTriggerTask":{
          "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": { "Fn::Join": [ "-", [ { "Ref": "AWS::StackName" }, { "Ref": "ContainerDefinitionName" } ] ] },
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": ["LambdaExecutionRole","Arn"]
                },
                "Code": {
                    "S3Bucket": {"Ref":"DataLakeS3Bucket"}, 
                    "S3Key": "sc-code/ecs/lambda_func.js.zip"
                },
                "Runtime": "nodejs10.x",
                "Timeout": 60,
                "TracingConfig": {
                    "Mode": "Active"
                },
                "Environment": {
                    "Variables": {
                        "CLUSTER_NAME": { "Fn::ImportValue" : "FargateClusterName" },
                        "ETL_CONF_DATALAKE_LOC": {"Ref":"DataLakeS3Bucket"}, 
                        "TASK_ID": {"Ref":"taskdefinition"},
                        "subnet_ids": {"Fn::Join": [",", [
                          { "Fn::ImportValue": "ECSPrivateSubnetOne"},
                          { "Fn::ImportValue": "ECSPrivateSubnetTwo"}
                          ]]
                        },
                        "container_name": {"Ref": "ContainerDefinitionName"},
                        "etl_task_sg_id": [{"Fn::ImportValue": "ECSFargateContainerSecurityGroup" }],
                      }
                }
          }
        },  
       "s3Permission": {
          "Type": "AWS::Lambda::Permission",
          "Properties": {
              "FunctionName": {
                  "Fn::GetAtt": ["LambdaTriggerTask","Arn"]
              },
              "Action": "lambda:InvokeFunction",
              "Principal": "s3.amazonaws.com",
              "SourceAccount": {
                  "Ref": "AWS::AccountId"
              },
              "SourceArn": {"Fn::Sub":"arn:aws:s3:::${DataLakeS3Bucket}"},
          }
        },
        "taskdefinition": {
            "Type": "AWS::ECS::TaskDefinition",
            "Properties" : {
                "ExecutionRoleArn": {"Fn::ImportValue": "ECSTaskExecutionRole"},
                "RequiresCompatibilities": [
                  "FARGATE"
                ],
                "Memory":  { "Fn::FindInMap" : [ "MapContainerSize", { "Ref" : "ContainerSize" }, "mem"]},
                "Family": {"Ref":"ContainerDefinitionName"},
                "NetworkMode": "awsvpc",
                "Cpu": { "Fn::FindInMap" : [ "MapContainerSize", { "Ref" : "ContainerSize" }, "cpu"]},
                "ContainerDefinitions" : [
                    {
                      "PortMappings": [
                        { "ContainerPort": {"Ref": "ContainerPort"} }
                      ],
                      "LogConfiguration": {
                        "LogDriver": "awslogs",
                        "Options": {
                          "awslogs-group": {"Ref":"TaskLogGroup"},
                          "awslogs-region": {"Ref":"AWS::Region"},
                          "awslogs-stream-prefix": "ecs"
                        }
                      },
                      "Command": [
                        "bin/spark-submit",
                        "--master",
                        "local[*]",
                        "--conf",
                        "spark.sql.streaming.checkpointLocation=covid19",
                        "--conf=spark.authenticate=true",
                        "--conf=spark.authenticate.secret=$(openssl rand -hex 64)",
                        "--conf=spark.io.encryption.enabled=true",
                        "--conf=spark.network.crypto.enabled=true",
                        "--conf=spark.sql.parser.quotedRegexColumnNames=true",
                        "--class",
                        "ai.tripl.arc.ARC",
                        "/opt/spark/jars/arc.jar"
                     ],
                     "Environment": [
                        {
                          "Name": "ETL_CONF_ENV",
                          "Value": "dev"
                        },
                        {
                          "Name": "ETL_CONF_JOB_NAME",
                          "Value": "ACIDtest"
                        },
                        {
                          "Name": "ETL_CONF_STREAMING",
                          "Value": "false"
                        },
                        {
                          "Name": "ETL_CONF_TAGS",
                          "Value": "project=ARCdemo cost_center=123456 owner=meloyang"
                        },
                        {
                          "Name": "ETL_CONF_URI",
                          "Value": "s3a://blahblah.json"
                        },
                        {
                          "Name": "ETL_CONF_DATALAKE_LOC",
                          "Value": "S3BucketTrigger"
                        }
                      ],
                      "Image": {"Ref":"ECRImageURI"},
                      "Name": {"Ref":"ContainerDefinitionName"}
                    }
                ]
            }
        }
    }
}